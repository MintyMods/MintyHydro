<!doctype html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <title>Minty Hydro Controller</title>
    <meta name='viewport' content='width=device-width,initial-scale=1.0'>
    <script type="text/javascript" src="/assets/dhtmlx/suite/suite.min.js"></script>
    <script type="text/javascript" src="/assets/dhtmlx/scheduler/dhtmlxscheduler.js"></script>
    <script type="text/javascript" src="/assets/dhtmlx/scheduler/ext/dhtmlxscheduler_timeline.js"></script>
    <script type="text/javascript" src="/assets/dhtmlx/scheduler/ext/dhtmlxscheduler_treetimeline.js"></script>
    <script type="text/javascript" src="/scripts/minty_utility_functions.js"></script>
    <link rel="stylesheet" href="/assets/dhtmlx/suite/suite.min.css">    
    <link rel="stylesheet" href="/assets/dhtmlx/skins/material/dhtmlx.css">    
    <link rel="stylesheet" href="/assets/dhtmlx/scheduler/dhtmlxscheduler.css">    
    <link rel="stylesheet" href="/assets/dhtmlx/scheduler/dhtmlxscheduler_material.css">    
    <link rel='stylesheet' href='/assets/fontawesome-pro/css/all.min.css'> 
</head>
<body>
    <div id="layout_container1"></div>
    <script>
    var navSelected = 'controls';    

    var layout= new dhx.Layout("layout_container", {
        "height":"100vh",
        "width":"100vw",
        "padding":0,
        "rows":[
        {
            "id":"toolbar_container",
            "gravity":false,
            "padding":0
        },
        {
            "cols":[
                {
                    "id":"sidebar_container",
                    "gravity":true,
                    "css":"dhx_layout-cell--border_right"
                },
                {
                    "id":"content_container",
                    "gravity":true,
                    "width":"100%",
                    "height":"100%"
                }
            ]
        }
        ]
    });
        
    var envLayout = new dhx.Layout(null, {
        height:'100%',
        width:'100%',
    	rows: [
            { id: "water_ph_container", gravity:true, padding: 0 },
            { id: "water_ec_container", gravity:true, padding: 0, html:"<div>@todo Current pH & chart showing history will go here!</div>" },
            { id: "water_temp_container", gravity:true, padding: 0, html:"<div>@todo Current EC & chart showing history will go here!</div>" },
            { id: "air_temp_container", gravity:true, padding: 0, html:"<div>@todo Current TEMP & chart showing history will go here!</div>" },
            { id: "air_humidity_container", gravity:true, padding: 0, html:"<div>@todo Current Humidity & chart showing history will go here!</div>" },
            { id: "control_container", gravity:true, padding: 0, html:"<div>@todo Show Running Status of all Controls Here as Icons</div>" },
            { cols: [ 
                { id: "extract_fan_container", gravity:true, css: "dhx_layout-cell--border_right" }, 
                { id: "intake_fan_container", gravity:true, width:'100%', height:'100%' } 
            ]}
        ]
    });

    // Toolbar Configuration 
	var toolbar = new dhx.Toolbar("toolbar_container", {
        css: "dhx_widget--border_bottom dhx_widget--bg_white",
    });
    toolbar.data.load('/json/toolbar.json');
	toolbar.events.on("click", function(id) {
        if (id === "toggle-sidebar") {
            sidebar.toggle();
		} else if (id === "toggle-sidebar") {
            showNotifications();
        }
	});
	layout.cell("toolbar_container").attach(toolbar);

    // Scheduler Configuration
    scheduler.config.header = [ "day","week","month","timeline","date","prev","today","next" ];
    scheduler.config.multi_day = true;
    var automation = [
    { key: 1, color:'gold', label: 'Grow Light' },
    { key: 2, color:'DimGrey', label: 'Extract Fan' },
    { key: 3, color:'deepskyblue', label: 'Intake Fan' },
    { key: 4, color:'fuchsia', label: 'Oscillating Fan'},
    { key: 5, color:'coral', label: 'Water Heater'},
    { key: 6, color:'HotPink', label: 'Air Heater'},
    { key: 7, color:'indigo', label: 'Humidifier'},
    { key: 8, color:'MediumSlateBlue', label: 'De-Humidifier'},
    { key: 9, color:'yellowgreen', label: 'Air Pump'},
    { key: 10, color:'Sienna', label: 'Recirculating Pump'},
    { key: 11, color:'darkred', label: '-- Res Change'},
    { key: 12, color:'Chartreuse', label: '-- Nutrient Dose'}
];

scheduler.locale.labels.timeline_tab ="Grow";
scheduler.createTimelineView({
     name:"timeline",
     x_unit:"minute", // measuring unit of the X-Axis.
     x_date:"%H:%i",  // date format of the X-Axis
     x_step:30,       // X-Axis step in 'x_unit's
     x_size:24,       // X-Axis length specified as the total number of 'x_step's
     x_start:16,      // X-Axis offset in 'x_unit's
     x_length:48,     // number of 'x_step's that will be scrolled at a time
     y_unit: automation,
     y_property:"section_id", // mapped data property
     render:"days"             // view mode
});

    scheduler.config.lightbox.sections=[
        { type: "select", id: "automation", map_to:"automation", name: "Control", options: automation },        
        {name:"time", height:72, type:"time", map_to:"auto"}
    ];  
    scheduler.templates.event_bar_text = function(start,end,event){
        if (event.automation) {
            event.color = automation[event.automation -1].color;
            return automation[event.automation -1].label + " Schedule";
        } else {
            return  "New Schedule";
        }
    };
    scheduler.attachEvent("onSchedulerReady", function () {
        requestAnimationFrame(function(){
            scheduler.setCurrentView(new Date(), "month");
            //scheduler.load('/json/scheduler.json');
        });
    });

    var pumpsForm;
    loadJSON('/json/pumps.json', function(response) {
        pumpsForm = new dhx.Form(null, JSON.parse(response));
    });

    var controlsForm;
    loadJSON('/json/controls.json', function(response) {
        controlsForm = new dhx.Form(null, JSON.parse(response));
    });
    
    var sensorsForm;
    loadJSON('/json/sensors.json', function(response) {
        sensorsForm = new dhx.Form(null, JSON.parse(response));
    });

    var configForm;
    loadJSON('/json/config.json', function(response) {
        configForm = new dhx.Form(null, JSON.parse(response));
    });

    var dosingGrid = new dhx.Grid(null, {
        columns: [
            { id: "0", width:120, type:'string', header: [{ text: "Stage:" }], footer: [{ text: "Total:" }] },
            { id: "1", width:120, type:'number', header: [{ text:"Seedling" }], footer: [{ content: "sum" }] },
            { id: "2", width:120, type:'number', header: [{ text: "Early Growth" }], footer: [{ content: "sum" }] },
            { id: "3", width:120, type:'number', header: [{ text: "Late Growth" }], footer: [{ content: "sum" }] },
            { id: "4", width:120, type:'number', header: [{ text: "Transition" }], footer: [{ content: "sum" }] },
            { id: "5", width:120, type:'number', header: [{ text: "Early Bloom" }], footer: [{ content: "sum" }] },
            { id: "6", width:120, type:'number', header: [{ text: "Mid Bloom" }], footer: [{ content: "sum" }] },
            { id: "7", width:120, type:'number', header: [{ text: "Late Bloom" }], footer: [{ content: "sum" }] },
            { id: "8", width:120, type:'number', header: [{ text: "Ripen" }], footer: [{ content: "sum" }] },
            { id: "9", width:120, type:'number', header: [{ text: "Flush" }], footer: [{ content: "sum" }] }
        ],
        autoWidth:false,
        editable:true,
        sortable:true,
        resizable: true,
        splitAt:1, 
    });
    dosingGrid.data.load('/json/dosing.json');

    // Side Bar Navigation
    var sidebar = new dhx.Sidebar("sidebar_container", { width:160, collapsed:false });
    sidebar.data.load('/json/sidebar.json');
    sidebar.events.on("click", function(id){
        console.log("Sidebar clikced " + id);
        if (id === "schedule") {
            layout.cell("content_container").attach(scheduler);
		} else if (id === "environment") {
            layout.cell("content_container").attach(envLayout);
		} else if (id === "pumps") {
            layout.cell("content_container").attach(pumpsForm);
        } else if (id === "controls") {
            layout.cell("content_container").attach(controlsForm);
        } else if (id === "sensors") {
            layout.cell("content_container").attach(sensorsForm);
        } else if (id === "dosing") {
            layout.cell("content_container").attach(dosingGrid);
        } else if (id === "settings") {
            layout.cell("content_container").attach(configForm);
        } else {
        }       
    });
    layout.cell("sidebar_container").attach(sidebar);
    layout.cell("content_container").attach(scheduler);

    </script>
<!-- 
    <label>ATLAS Shield</label>    
    <button class="reading" id="ATLAS_GET_TEMP">Get Temperature</button>
    <span id="atlas_temp_reading">???.???°C</span>
    <button class="reading" id="ATLAS_GET_PH">Get PH</button>
    <span id="atlas_ph_reading">?.??? ph</span>
    <button class="reading" id="ATLAS_GET_EC">Get EC</button>
    <span id="atlas_ec_reading">?.?? ppm</span>
    <br/>
    <label>MINTY-FDD</label>
    <select id="TEST_RF_12V">MINTY-FDD
        <option value="2775136">ALL Close</option>
        <option value="2775144">Drip Feeder</option>
        <option value="2775140">Fill</option>
        <option value="2775138">Drain</option>
        <option value="2775137">Mix Nutrients</option>
   </select>
    <br/>
    <label>PUMPS</label>
    <select id="PUMP_SELECT">Pump:
        <option value="">Select Pump</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="E">E</option>
        <option value="F">F</option>
        <option value="G">G</option>
        <option value="H">H</option>
    </select>
    <button class="off" id="PUMP_STOP">Stop</button>
    <button class="on" id="PUMP_START">Start</button>
    <input type="text" id="PUMP_SPEED" value="127" size="4"/>Speed

   <div class="temperatures">
       <span>Humidity : </span><span class="humidity" id="HTS_BME280_HUMIDITY">??.???% RH</span> 
       <br/><span>Temperature : </span><span class="temperature" id="HTS_BME280_TEMP_CELSIUS">??.??°C</span>
   </div>
    <div class="waterlevels">
        <span>Water Tank : </span>
        <span id="WLS_TANK_HIGH">High Level</span> | <span id="WLS_TANK_LOW">Low Level</span>
        <br/><span>Resovoir : </span>
        <span id="WLS_RES_HIGH">High Level</span> |  <span id="WLS_RES_LOW">Low Level</span>
    </div>
    <button class="off" id="HUMIDIFIER_OFF">Humidifier Off</button>
    <button class="low" id="HUMIDIFIER_LOW">Humidifier Low</button>
    <button class="high" id="HUMIDIFIER_HIGH">Humidifier High</button>
    <br/>
    <i class="fal fa-fan"></i>   
    <button class="off" id="AIR_INTAKE_FAN_OFF">Air Intake Fan Off</button>
    <button class="low" id="AIR_INTAKE_FAN_LOW">Air Intake Fan Low</button>
    <button class="high" id="AIR_INTAKE_FAN_HIGH">Air Intake Fan High</button>
    <br/>

    <i class="fal fa-lightbulb-on"></i>
    <i class="fal fa-lightbulb"></i>
    <button class="off" id="LIGHT_OFF">Light OFF</button>
    <button class="on" id="LIGHT_ON">Light ON</button>
    <br/>
    <i class="fal fa-faucet-drip"></i>
    <i class="fal fa-faucet"></i>
    <button class="off" id="WATER_PUMP_OFF">Water Pump Off</button>
    <button class="on" id="WATER_PUMP_ON">Water Pump On</button>
    <br/>
    <i class="fal fa-water"></i>
    <button class="off" id="WATER_HEATER_OFF">Water Heater Off</button>
    <button class="on" id="WATER_HEATER_ON">Water Heater On</button>
    <br/>
    <i class="fal fa-heat"></i>
    <button class="off" id="HEATER_OFF">Heater Off</button>
    <button class="on" id="HEATER_ON">Heater On</button>
    <br/>
    <i class="fal fa-wind"></i>
    <button class="off" id="AIR_PUMP_OFF">Air Pump Off</button>
    <button class="on" id="AIR_PUMP_ON">Air Pump On</button>
    <br/>
    <i class="fal fa-fan-table"></i>
    <button class="off" id="AIR_MOVEMENT_FAN_OFF">Air Movement Fans Off</button>
    <button class="on" id="AIR_MOVEMENT_FAN_ON">Air Movement Fans On</button>
    <br/>
    <i class="fal fa-fan"></i>   
    <button class="off" id="AIR_EXTRACT_FAN_OFF">Air Extract Fan Off</button>
    <button class="on" id="AIR_EXTRACT_FAN_ON">Air Extract Fan On</button>
    <br/>
    <i class="fal fa-dewpoint"></i>
    <button class="off" id="DEHUMIDIFIER_OFF">Dehumidifier Off</button>
    <button class="on" id="DEHUMIDIFIER_ON">Dehumidifier On</button> -->
</body>
</html>
